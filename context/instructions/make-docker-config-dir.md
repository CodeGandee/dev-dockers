you are tasked to create a docker compose environment directory built with PeiDocker (`pei-docker-cli`).

the key convention in this repo is to separate:
- `dockers/<env-name>/src/`: a PeiDocker project directory (generated by `pei-docker-cli create` and then used by `pei-docker-cli configure`)
- `dockers/<env-name>/delta/`: your tracked edits/overrides (the canonical “source of truth”)

PeiDocker’s intended workflow is:
1) `create` a project
2) modify `user_config.yml`
3) `configure` to generate Docker files
4) optionally edit the generated `docker-compose.yml` for features not supported by the config system

to make this safe and repeatable, we split `delta/` into two phases:
- `delta/post-create/`: changes applied after `create` but before `configure` (includes `user_config.persist.yml`)
- `delta/post-configure/`: changes applied after `configure` (for example customizing generated `docker-compose.yml`)

`pei-configure.sh` applies these deltas into `src/` (with sanity checks). use:
- `./pei-configure.sh --apply-post-create`
- `./pei-configure.sh --apply-post-configure`

goal: it must always be safe to delete/recreate `src/` via `pei-docker-cli create` and then re-apply `delta/` to produce a valid, buildable set of Docker files (compose + Dockerfiles + generated hooks) without losing your environment-specific changes.

## expected directory tree

create the environment root directory (commonly `dockers/<env-name>/`) with at least:

```text
dockers/<env-name>/
  README.md
  env.example
  pei-configure.sh
  delta/
    README.md
    post-create/
      .gitkeep
      user_config.persist.yml
      # only include files you actually override/add
      # (this tree shows common examples; do not copy it verbatim)
      (optional overlay; mirrors paths under src/)
      installation/
        stage-1/
        stage-2/
      compose-template.yml
    post-configure/
      .gitkeep
      # only include files you actually override/add
      # (this tree shows common examples; do not copy it verbatim)
      (optional overlay; mirrors *generated* files under src/)
      docker-compose.yml   (example)
      merged.Dockerfile    (example; rare)
      merged.env           (example; rare)
      build-merged.sh      (example; rare)
      run-merged.sh        (example; rare)
  src/   (generated by PeiDocker, then patched by pei-configure.sh)
```

optional but recommended:

```text
dockers/<env-name>/
  docs/
    README.md
  memo/
    README.md
  issues/
```

notes:
- `.env` is not tracked; `env.example` must be tracked.
- do not hand-create the whole `src/` tree; generate it via `pei-docker-cli create`.
- do not keep your canonical edits in `src/` (because `pei-docker-cli create` can overwrite files there). keep edits in `delta/`.

## scaffold workflow (recommended)

1) generate `src/` via PeiDocker:

```bash
mkdir -p dockers/<env-name>
pixi run pei-docker-cli create -p dockers/<env-name>/src
```

2) initialize `delta/` and create the canonical config:

```bash
mkdir -p dockers/<env-name>/delta
mkdir -p dockers/<env-name>/delta/post-create
mkdir -p dockers/<env-name>/delta/post-configure
touch dockers/<env-name>/delta/post-create/.gitkeep
touch dockers/<env-name>/delta/post-configure/.gitkeep
cp dockers/<env-name>/src/user_config.yml dockers/<env-name>/delta/post-create/user_config.persist.yml
```

3) make changes only under `delta/`:
- edit `delta/post-create/user_config.persist.yml`
- add new scripts under `delta/post-create/installation/stage-*/custom/` (preferred)
- only override PeiDocker “system” scripts if you must (store the overridden file at the same relative path under `delta/post-create/installation/...`)
- if you need to customize generated outputs (example: docker-compose features not supported by config), put those in `delta/post-configure/` (see below)

4) apply deltas + configure (typical):

```bash
cd dockers/<env-name>
./pei-configure.sh --apply-post-create
cd src && pixi run pei-docker-cli configure --with-merged
cd .. && ./pei-configure.sh --apply-post-configure
```

## what each file should contain

### `README.md` (env root)

must include:
- env purpose (1-2 lines)
- quick start:
  - `./pei-configure.sh --apply-post-create`
  - `cd src && pixi run pei-docker-cli configure --with-merged` (or without `--with-merged` if you don’t use merged builds)
  - `./pei-configure.sh --apply-post-configure` (if you have any post-configure overlay)
  - build: `docker compose -f src/docker-compose.yml build stage-2`
  - run: `docker compose -f src/docker-compose.yml up -d stage-2`
- note that `.env` is not tracked and should be copied from `env.example`
- pointers to `docs/` / `memo/` if they exist

### `env.example`

must list all host-overridable settings used by `src/user_config.yml` after overlay, especially:
- `HOST_PORT_*` used for services (example: `HOST_PORT_SSH`, `HOST_PORT_PROXY`)
- any `HOST_VOLUME_*` paths if you mount host directories

keep this file minimal and safe (no secrets).

### `delta/post-create/user_config.persist.yml` (canonical config)

this is the canonical, hand-edited PeiDocker user config you commit.

why:
- `pei-docker-cli create` writes/overwrites `src/user_config.yml`
- keeping canonical config under `delta/` prevents accidental loss when re-running `create`

best practice:
- edit `delta/post-create/user_config.persist.yml`
- `pei-configure.sh --apply-post-create` copies it to `src/user_config.yml` before you run `configure`

### `delta/post-create/` overlay layout

`delta/post-create/` mirrors paths under `src/` and is copied into `src/` by `pei-configure.sh --apply-post-create`.

common cases:
- add custom hooks:
  - `delta/post-create/installation/stage-1/custom/*.sh`
  - `delta/post-create/installation/stage-2/custom/*.sh`
- override a PeiDocker-provided script (use sparingly):
  - `delta/post-create/installation/stage-*/system/<...>/some-script.sh`
- override compose template (rare):
  - `delta/post-create/compose-template.yml` (overwrites `src/compose-template.yml`)

### `delta/post-configure/` overlay layout

`delta/post-configure/` mirrors *generated* outputs under `src/` and is copied into `src/` by `pei-configure.sh --apply-post-configure`.

use this for changes that PeiDocker explicitly expects users to do *after* `configure`, for example:
- manual edits to `src/docker-compose.yml` for compose features not modeled in `user_config.yml`
- manual edits to generated helper scripts (rare; prefer updating inputs so they re-generate correctly)

store the full overridden file(s) under `delta/post-configure/` with the same relative path as in `src/`, for example:
- `delta/post-configure/docker-compose.yml` → `src/docker-compose.yml`

### `src/` (generated + patched)

`src/` is a PeiDocker project directory. it contains:
- files produced by `pei-docker-cli create` (templates + installation tree)
- files produced by `pei-docker-cli configure` (docker-compose.yml, Dockerfiles, merged artifacts, generated hook scripts)
- the applied `delta/` overlay (after running `pei-configure.sh`)

do not treat `src/` as your canonical edit location; it is allowed to be regenerated.

## `pei-configure.sh` (required)

`pei-configure.sh` exists to make the workflow safe and repeatable:
- apply `delta/post-create/` and `delta/post-configure/` into `src/`
- fail fast on obvious PeiDocker template/version mismatches
- provide explicit “apply” steps around the PeiDocker `create → configure` flow

### required behavior

`pei-configure.sh` should:

1) sanity-check required paths:
- `src/compose-template.yml` exists
- `src/reference_config.yml` exists
- `src/installation/stage-1/` and `src/installation/stage-2/` exist
- `delta/post-create/user_config.persist.yml` exists

2) `--apply-post-create`: apply the overlay in a safe way:
- always allow copying new files under `delta/post-create/installation/stage-*/custom/`
- for overrides outside `custom/` (for example `delta/post-create/installation/stage-*/system/...`), require that the destination path already exists in `src/` before overwriting
  - if the destination does not exist, fail with a clear “template/version mismatch” message (this usually means PeiDocker changed its template paths)
- if `delta/post-create/compose-template.yml` exists, require `src/compose-template.yml` exists, then overwrite it

3) `--apply-post-create`: write the config that PeiDocker consumes:
- copy-overwrite `delta/post-create/user_config.persist.yml` to `src/user_config.yml`

4) `--apply-post-configure`: apply overlay to generated artifacts:
- for each file in `delta/post-configure/**`, require the destination already exists in `src/**` before overwriting
  - if not, fail with a clear “configure output mismatch” message (this usually means PeiDocker changed what it generates or you didn’t run `configure` yet)

`pei-configure.sh` may also provide a convenience mode to run configure itself, but the minimum required features are the two apply phases above.

## validation checklist

after creating/updating the directory:
- `cd dockers/<env-name> && ./pei-configure.sh --apply-post-create` succeeds
- `cd dockers/<env-name>/src && pixi run pei-docker-cli configure --with-merged` succeeds (or without `--with-merged` if unsupported)
- `cd dockers/<env-name> && ./pei-configure.sh --apply-post-configure` succeeds (if you have any post-configure overlay)
- `src/docker-compose.yml` exists and can be used from the env root:
  - `docker compose -f src/docker-compose.yml build stage-2`
  - `docker compose -f src/docker-compose.yml up -d stage-2`
- `env.example` matches the env vars used by `delta/post-create/user_config.persist.yml` / `src/user_config.yml`
- `.env` is not committed

## references

- PeiDocker repository: `https://github.com/igamenovoer/PeiDocker`
